From baedd00ada89a6cb35a9656f59970e7c01a776f9 Mon Sep 17 00:00:00 2001
From: Priyanka Bose <priyanka.bose@intel.com>
Date: Wed, 17 Apr 2019 18:51:51 +0530
Subject: [PATCH] Enable libart to use ipp optimized static libz.

Category: Device Enablement
Origin: Internal
Upstream-Candidate: no
Tracked-On: https://jira.devtools.intel.com/browse/OAM-79155
Signed-off-by: Priyanka Bose <priyanka.bose@intel.com>
---
 dexlayout/Android.bp  | 21 ++++++++++++++++++++-
 libdexfile/Android.bp | 19 +++++++++++++++----
 runtime/Android.bp    | 17 ++++++++++++-----
 3 files changed, 47 insertions(+), 10 deletions(-)

diff --git a/dexlayout/Android.bp b/dexlayout/Android.bp
index 33ba58f5f..4d0d2bf2d 100644
--- a/dexlayout/Android.bp
+++ b/dexlayout/Android.bp
@@ -29,7 +29,26 @@ art_cc_defaults {
     shared_libs: [
         "libbase",
     ],
-    static_libs: ["libz"],
+    target: {
+      android_x86: {
+            static_libs: [
+                // ZipArchive support, the order matters here to get all symbols.
+                "libziparchive",
+                "libz", //static version of libz as a part of inflate
+            ],
+        },
+     android_x86_64: {
+            static_libs: [
+                // ZipArchive support, the order matters here to get all symbols.
+                "libziparchive",
+                "libz_ipp",
+                "zlib-ipp",
+            ],
+        },
+     host: {
+         static_libs: ["libz"],
+     },
+   },
 }
 
 art_cc_library {
diff --git a/libdexfile/Android.bp b/libdexfile/Android.bp
index 1e2686a00..15078d366 100644
--- a/libdexfile/Android.bp
+++ b/libdexfile/Android.bp
@@ -37,14 +37,25 @@ cc_defaults {
 
     target: {
         android: {
-            static_libs: [
-                "libziparchive",
-                "libz",
-            ],
             shared_libs: [
                 "libutils",
             ],
         },
+        android_x86: {
+	    static_libs: [
+                // ZipArchive support, the order matters here to get all symbols.
+                "libziparchive",
+                "libz", //static version of libz as a part of inflate
+            ],
+        },
+        android_x86_64: {
+	    static_libs: [
+                // ZipArchive support, the order matters here to get all symbols.
+                "libziparchive",
+                "libz_ipp",
+                "zlib-ipp",
+            ],
+        },
         host: {
             shared_libs: [
                 "libziparchive",
diff --git a/runtime/Android.bp b/runtime/Android.bp
index 23e242533..0f5196ec6 100644
--- a/runtime/Android.bp
+++ b/runtime/Android.bp
@@ -373,11 +373,7 @@ cc_defaults {
                 "libutils",
                 "libtombstoned_client",
             ],
-            static_libs: [
-                // ZipArchive support, the order matters here to get all symbols.
-                "libziparchive",
-                "libz",
-            ],
+
         },
         android_arm: {
             ldflags: JIT_DEBUG_REGISTER_CODE_LDFLAGS,
@@ -387,9 +383,20 @@ cc_defaults {
         },
         android_x86: {
             ldflags: JIT_DEBUG_REGISTER_CODE_LDFLAGS,
+	    static_libs: [
+                // ZipArchive support, the order matters here to get all symbols.
+                "libziparchive",
+                "libz", //static version of libz as a part of inflate
+            ],
         },
         android_x86_64: {
             ldflags: JIT_DEBUG_REGISTER_CODE_LDFLAGS,
+	    static_libs: [
+                // ZipArchive support, the order matters here to get all symbols.
+                "libziparchive",
+                "libz_ipp",
+                "zlib-ipp",
+            ],
         },
         host: {
             srcs: [
-- 
2.20.1

